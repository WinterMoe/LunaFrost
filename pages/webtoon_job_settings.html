{% extends "base.html" %}

{% block title %}{{ webtoon.title }} - Settings - LunaFrost Translator{% endblock %}

{% block content %}
<div class="container">
    <header>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <a href="/webtoon/{{ webtoon.job_id }}" class="btn btn-primary">‚Üê Back to Webtoon</a>
        </div>
        <h1>{{ webtoon.title or webtoon.job_id }}</h1>
        <p class="subtitle">{{ 'Manga' if webtoon.reading_mode == 'manga' else 'Webtoon' }} Settings</p>
    </header>

    <div id="alert-container"></div>

    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('info-content', 'info-icon')">
            <h2>üìä {{ 'Manga' if webtoon.reading_mode == 'manga' else 'Webtoon' }} Information</h2>
            <span class="collapse-icon" id="info-icon">‚ñº</span>
        </div>
        <div class="collapsible-content" id="info-content">
            <div style="color: #718096; margin-bottom: 15px;">
                <p><strong>Status:</strong> {{ webtoon.status }}</p>
                <p><strong>Total Images:</strong> {{ webtoon.total_images }}</p>
                <p><strong>Processed:</strong> {{ webtoon.processed_images }}</p>
                {% if webtoon.failed_images > 0 %}
                <p><strong>Failed:</strong> <span style="color: #e53e3e;">{{ webtoon.failed_images }}</span></p>
                {% endif %}
                <p><strong>OCR Method:</strong> {{ webtoon.ocr_method }}</p>
                {% if webtoon.created_at %}
                <p><strong>Created:</strong> {{ webtoon.created_at[:10] }}</p>
                {% endif %}
                {% if webtoon.completed_at %}
                <p><strong>Completed:</strong> {{ webtoon.completed_at[:10] }}</p>
                {% endif %}
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border-light); margin: 20px 0;">

            
            <div class="form-group">
                <label for="webtoon-source-lang">Source Language</label>
                <select id="webtoon-source-lang" class="form-control">
                    <option value="korean" {% if webtoon.source_language=='korean' %}selected{% endif %}>Korean</option>
                    <option value="japanese" {% if webtoon.source_language=='japanese' %}selected{% endif %}>Japanese
                    </option>
                </select>
            </div>
            <div class="form-group">
                <label for="webtoon-tags">Tags</label>
                <input type="text" id="webtoon-tags" class="form-control" value="{{ webtoon.tags or '' }}"
                    placeholder="fantasy, action, romance">
            </div>
            <button id="save-metadata-btn" class="btn btn-primary" style="margin-top: 10px;">üíæ Save Metadata</button>
        </div>
    </div>

    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('export-content', 'export-icon')">
            <h2>üì• Export {{ 'Manga' if webtoon.reading_mode == 'manga' else 'Webtoon' }}</h2>
            <span class="collapse-icon collapsed" id="export-icon">‚ñº</span>
        </div>
        <div class="collapsible-content collapsed" id="export-content">
            <p style="color: #718096; margin-bottom: 15px;">
                Download all translated images as a ZIP file.
            </p>
            <button id="export-zip-btn" class="btn btn-export" style="padding: 12px 24px;">
                üì¶ Download All Images (ZIP)
            </button>
        </div>
    </div>

    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('glossary-content', 'glossary-icon')">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                <h2 style="margin: 0;">üìù Character Glossary</h2>
            </div>
            <span class="collapse-icon" id="glossary-icon">‚ñº</span>
        </div>
        <div class="collapsible-content" id="glossary-content">
            <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 15px;">
                <button id="add-entry-btn" class="btn btn-secondary btn-sm">‚ûï Add Entry</button>
                <button id="save-glossary-btn" class="btn btn-primary btn-sm">üíæ Save Glossary</button>
            </div>
            <p class="help-text" style="margin-bottom: 12px;">
                Keep names consistent across your {{ 'manga' if webtoon.reading_mode == 'manga' else 'webtoon' }}.
                Gender
                guides pronoun choices (male = he/him, female = she/her, other = they/them, auto = AI decides).
            </p>
            <div class="table-responsive">
                <table class="table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 10px; text-align: left;">Korean Name</th>
                            <th style="padding: 10px; text-align: left;">English Name</th>
                            <th style="padding: 10px; text-align: left; width: 140px;">Gender</th>
                            <th style="padding: 10px; text-align: center; width: 80px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="glossary-body">
                        <tr id="glossary-empty-row">
                            <td colspan="4" style="padding: 12px; color: #718096; text-align: center;">No characters
                                yet.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    
    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('custom-prompt-content', 'custom-prompt-icon')">
            <h2>ü§ñ Custom Translation Prompt</h2>
            <span class="collapse-icon collapsed" id="custom-prompt-icon">‚ñº</span>
        </div>
        <div class="collapsible-content collapsed" id="custom-prompt-content">
            <p style="color: #718096; margin-bottom: 15px;">
                These instructions will be appended to the system prompt for every image translation.
                Useful for specifying style, tone, or specific requests not covered by the glossary.
            </p>
            <textarea id="custom-prompt-suffix" class="form-control" rows="4"
                placeholder="e.g. Keep sound effects in Korean but translate bubble text. Use informal tone.">{{ webtoon.custom_prompt_suffix or '' }}</textarea>

            <button id="save-prompt-btn" class="btn btn-primary" style="margin-top: 15px;">üíæ Save Custom
                Prompt</button>
        </div>
    </div>

    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('image-status-content')">
            <h2>üñºÔ∏è Image Status</h2>
            <span class="collapse-icon collapsed" id="image-status-icon">‚ñº</span>
        </div>
        <div class="collapsible-content collapsed" id="image-status-content">
            <p style="color: #718096; margin-bottom: 15px;">
                View the status of all images in this {{ 'manga' if webtoon.reading_mode == 'manga' else 'webtoon' }}.
            </p>
            {% if webtoon.images and webtoon.images|length > 0 %}
            <div
                style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-light); border-radius: 8px; padding: 15px;">
                {% for image in webtoon.images %}
                <div
                    style="padding: 10px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">{{ image.original_filename }}</div>
                        <div style="font-size: 0.85rem; color: #718096; margin-top: 5px;">
                            Status:
                            {% if image.status == 'completed' %}
                            <span style="color: #48bb78;">‚úÖ Completed</span>
                            {% elif image.status == 'processing' %}
                            <span style="color: #ed8936;">‚è≥ Processing</span>
                            {% elif image.status == 'failed' %}
                            <span style="color: #e53e3e;">‚ùå Failed</span>
                            {% else %}
                            <span style="color: #a0aec0;">‚è∏Ô∏è Pending</span>
                            {% endif %}
                        </div>
                        {% if image.error_message %}
                        <div style="font-size: 0.85rem; color: #e53e3e; margin-top: 5px;">
                            Error: {{ image.error_message }}
                        </div>
                        {% endif %}
                    </div>
                    {% if image.status == 'completed' and image.url %}
                    <div style="margin-left: 15px;">
                        <a href="{{ image.url }}" target="_blank" class="btn btn-secondary"
                            style="padding: 6px 12px; font-size: 0.85rem;">
                            üëÅÔ∏è View
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="color: #718096;">No images found.</p>
            {% endif %}
        </div>
    </div>

    <div class="settings-card">
        <h2>‚ö†Ô∏è Danger Zone</h2>
        <div class="alert alert-warning" style="margin-bottom: 15px;">
            <strong>Warning:</strong> Deleting this webtoon will permanently remove all images and translation data.
            This action cannot be undone.
        </div>
        <button id="delete-webtoon-btn" class="btn btn-danger" style="padding: 12px 24px;">
            üóëÔ∏è Delete Entire Webtoon
        </button>
    </div>
</div>

<style>
    .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }

    .collapsible-header:hover {
        opacity: 0.8;
    }

    .collapsible-header h2 {
        margin: 0;
    }

    .collapse-icon {
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .collapse-icon.collapsed {
        transform: rotate(-90deg);
    }

    .collapsible-content {
        overflow: hidden;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
        max-height: 2000px;
        opacity: 1;
        padding-top: 15px;
    }

    .collapsible-content.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }

    table th,
    table td {
        border-bottom: 1px solid var(--border-light);
    }

    .table-responsive {
        width: 100%;
        overflow-x: auto;
    }
</style>

<script>

    function toggleCollapse(contentId) {
        const content = document.getElementById(contentId);
        const icon = document.getElementById(contentId.replace('-content', '-icon'));
        if (content && icon) {
            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }
    }

    const glossaryBody = document.getElementById('glossary-body');
    const glossaryEmptyRow = document.getElementById('glossary-empty-row');
    const addEntryBtn = document.getElementById('add-entry-btn');
    const saveGlossaryBtn = document.getElementById('save-glossary-btn');
    let glossaryEntries = {{ webtoon.glossary| tojson }};

    function renderGlossary() {
        glossaryBody.innerHTML = '';
        if (!glossaryEntries || glossaryEntries.length === 0) {
            glossaryBody.appendChild(glossaryEmptyRow);
            glossaryEmptyRow.style.display = 'table-row';
            return;
        }
        glossaryEmptyRow.style.display = 'none';

        glossaryEntries.forEach((entry, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 8px;">
                    <input type="text" class="form-control" value="${entry.korean_name || ''}" data-idx="${idx}" data-field="korean_name" placeholder="e.g., ÍπÄÏ≤†Ïàò">
                </td>
                <td style="padding: 8px;">
                    <input type="text" class="form-control" value="${entry.english_name || ''}" data-idx="${idx}" data-field="english_name" placeholder="e.g., Cheolsu Kim">
                </td>
                <td style="padding: 8px;">
                    <select class="form-control" data-idx="${idx}" data-field="gender">
                        ${['male', 'female', 'other', 'auto'].map(g => `<option value="${g}" ${entry.gender === g ? 'selected' : ''}>${g}</option>`).join('')}
                    </select>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <button class="btn btn-outline-danger btn-sm" data-remove="${idx}" title="Remove">‚úï</button>
                </td>
            `;
            glossaryBody.appendChild(tr);
        });

        glossaryBody.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('input', (e) => {
                const { idx, field } = e.target.dataset;
                glossaryEntries[idx][field] = e.target.value;
            });
        });

        glossaryBody.querySelectorAll('button[data-remove]').forEach(btn => {
            btn.addEventListener('click', () => {
                const idx = parseInt(btn.dataset.remove, 10);
                glossaryEntries.splice(idx, 1);
                renderGlossary();
            });
        });
    }

    if (addEntryBtn) {
        addEntryBtn.addEventListener('click', () => {
            glossaryEntries.push({
                korean_name: '',
                english_name: '',
                gender: 'auto'
            });
            renderGlossary();
        });
    }

    if (saveGlossaryBtn) {
        saveGlossaryBtn.addEventListener('click', async () => {
            saveGlossaryBtn.disabled = true;
            const originalText = saveGlossaryBtn.textContent;
            saveGlossaryBtn.textContent = 'Saving...';

            const payload = glossaryEntries
                .map(e => ({
                    korean_name: (e.korean_name || '').trim(),
                    english_name: (e.english_name || '').trim(),
                    gender: (e.gender || 'auto').trim().toLowerCase(),
                }))
                .filter(e => e.korean_name && e.english_name);

            try {
                const res = await fetchWithCSRF(`/api/webtoon/{{ webtoon.job_id }}/glossary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ glossary: payload })
                });
                const data = await res.json();
                if (data.success) {
                    glossaryEntries = data.glossary || [];
                    renderGlossary();
                    window.showAlertModal('Success', 'Glossary saved', 'success');
                } else {
                    throw new Error(data.error || 'Failed to save glossary');
                }
            } catch (e) {
                console.error('Glossary save error', e);
                window.showAlertModal('Error', e.message, 'error');
            } finally {
                saveGlossaryBtn.disabled = false;
                saveGlossaryBtn.textContent = originalText;
            }
        });
    }

    renderGlossary();

    const exportZipBtn = document.getElementById('export-zip-btn');
    if (exportZipBtn) {
        exportZipBtn.addEventListener('click', async () => {
            exportZipBtn.disabled = true;
            const originalText = exportZipBtn.textContent;
            exportZipBtn.textContent = 'Preparing download...';

            try {

                const response = await fetchWithCSRF(`/api/webtoon/job/{{ webtoon.job_id }}/export`, {
                    method: 'GET',
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `webtoon_{{ webtoon.job_id[:8] }}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    window.showAlertModal('Success', 'Webtoon exported successfully!', 'success');
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to export webtoon');
                }
            } catch (error) {
                console.error('Error exporting webtoon:', error);

                window.showAlertModal('Info', 'ZIP export is coming soon. For now, you can download individual images from the webtoon page.', 'info');
            } finally {
                exportZipBtn.disabled = false;
                exportZipBtn.textContent = originalText;
            }
        });
    }

    const deleteWebtoonBtn = document.getElementById('delete-webtoon-btn');
    if (deleteWebtoonBtn) {
        deleteWebtoonBtn.addEventListener('click', async () => {
            const confirmed = confirm('Are you sure you want to delete this webtoon? This action cannot be undone.');

            if (!confirmed) {
                return;
            }

            deleteWebtoonBtn.disabled = true;
            const originalText = deleteWebtoonBtn.textContent;
            deleteWebtoonBtn.textContent = 'Deleting...';

            try {
                const response = await fetchWithCSRF(`/api/webtoon/job/{{ webtoon.job_id }}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    window.showAlertModal('Success', 'Webtoon deleted successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Failed to delete webtoon');
                }
            } catch (error) {
                console.error('Error deleting webtoon:', error);
                window.showAlertModal('Error', error.message, 'error');
                deleteWebtoonBtn.disabled = false;
                deleteWebtoonBtn.textContent = originalText;
            }
        });
    }

    const saveMetadataBtn = document.getElementById('save-metadata-btn');
    if (saveMetadataBtn) {
        saveMetadataBtn.addEventListener('click', async () => {
            saveMetadataBtn.disabled = true;
            const originalText = saveMetadataBtn.textContent;
            saveMetadataBtn.textContent = 'Saving...';

            const payload = {
                tags: document.getElementById('webtoon-tags').value,
                source_language: document.getElementById('webtoon-source-lang').value

            };

            try {
                const res = await fetchWithCSRF(`/api/webtoon/{{ webtoon.job_id }}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    window.showAlertModal('Success', 'Metadata updated successfully', 'success');
                } else {
                    throw new Error(data.error || 'Failed to update');
                }
            } catch (e) {
                console.error('Update error', e);
                window.showAlertModal('Error', e.message, 'error');
            } finally {
                saveMetadataBtn.disabled = false;
                saveMetadataBtn.textContent = originalText;
            }
        });
    }
</script>
{% endblock %}