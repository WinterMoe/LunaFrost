{% extends "base.html" %}

{% block title %}Translate Webtoon Images - LunaFrost Translator{% endblock %}

{% block content %}
<div class="container">
    <header>
        <div style="margin-bottom: 20px;">
            <a href="/" class="btn btn-primary">‚Üê Back to Novels</a>
        </div>
        <h1>üñºÔ∏è Translate Webtoon Images</h1>
        <p class="help-text">Upload images manually from your device to translate webtoon/manga text to English</p>
    </header>

    <div class="settings-card">
        <form id="webtoon-upload-form" enctype="multipart/form-data">
            
            <div style="margin-bottom: 20px;">
                <div id="drop-zone" class="border border-dashed border-3 rounded p-5 text-center"
                    style="background-color: #f8f9fa; cursor: pointer; min-height: 200px; border-color: #dee2e6 !important;">
                    <div style="font-size: 3rem; color: #6c757d; margin-bottom: 10px;">üì§</div>
                    <h5 class="mt-3">Drag & Drop Images Here</h5>
                    <p class="text-muted">or click to browse</p>
                    <input type="file" class="d-none" id="webtoon-images" name="images" multiple
                        accept="image/png,image/jpeg,image/jpg,image/webp" required>
                    <div class="help-text mt-2">Supported formats: PNG, JPG, JPEG, WebP (Max 10MB per file)</div>
                </div>
            </div>

            
            <div id="file-preview-container" class="d-none" style="margin-bottom: 20px;">
                <h5>Selected Images (<span id="file-count">0</span>)</h5>
                <div id="file-preview" class="row g-2"></div>
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="clear-files-btn">Clear All</button>
            </div>

            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="source-language">Source Language</label>
                <select class="form-control" id="source-language" name="source_language" required>
                    <option value="korean">Korean (ÌïúÍµ≠Ïñ¥)</option>
                    <option value="japanese">Japanese (Êó•Êú¨Ë™û)</option>
                </select>
                <p class="help-text">
                    Select the language of the text in your images. This helps the AI provide better translations.
                </p>
            </div>

            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="ocr-method">OCR Method</label>
                <select class="form-control" id="ocr-method" name="ocr_method">
                    <option value="google">Google Cloud Vision (Requires API Key)</option>
                    <option value="azure">Azure Computer Vision (Requires API Key)</option>
                    <option value="nanobananapro">Nano Banana Pro (Best Quality - Requires API Key)</option>
                </select>
                <p class="help-text">
                    <a href="/settings" target="_blank">Configure API keys in settings</a>
                </p>
            </div>

            
            <button type="submit" class="btn btn-primary btn-lg w-100" id="submit-btn" disabled>
                <span id="submit-text">Start Translation</span>
                <span id="submit-spinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
            </button>
        </form>
    </div>

    
    <div class="settings-card mt-4 d-none" id="progress-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0;">Translation Progress</h4>
            <span id="job-id-badge" class="badge bg-secondary"></span>
        </div>
        <div style="margin-bottom: 20px;">
            <div class="progress" style="height: 30px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                    role="progressbar" style="width: 0%">
                    <span id="progress-text">0%</span>
                </div>
            </div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <div>
                <strong>Status:</strong> <span id="job-status">Pending</span>
            </div>
            <div>
                <strong>Processed:</strong> <span id="processed-count">0</span> / <span id="total-count">0</span>
            </div>
        </div>
        <div id="error-messages"
            style="display: none; margin-top: 15px; padding: 12px; background: #fed7d7; border: 1px solid #fc8181; border-radius: 8px; color: #742a2a;">
        </div>
        <div id="image-results" class="mt-4"></div>
    </div>
</div>

<style>
    #drop-zone.drag-over {
        background-color: #e7f3ff !important;
        border-color: #0d6efd !important;
    }

    .preview-image {
        position: relative;
        margin-bottom: 10px;
    }

    .preview-image img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 5px;
    }

    .preview-image .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        font-size: 16px;
        line-height: 1;
    }
</style>

<script src="{{ url_for('static', filename='js/csrf.js') }}"></script>
<script>
    let currentJobId = null;
    let pollInterval = null;
    let selectedFiles = [];

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('webtoon-images');
    const filePreview = document.getElementById('file-preview');
    const filePreviewContainer = document.getElementById('file-preview-container');
    const fileCount = document.getElementById('file-count');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        const validFiles = Array.from(files).filter(file => {
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
            const maxSize = 10 * 1024 * 1024;

            if (!validTypes.includes(file.type)) {
                window.showAlertModal('Invalid File', `${file.name} is not a valid image type. Please use PNG, JPG, or WebP.`, 'error');
                return false;
            }

            if (file.size > maxSize) {
                window.showAlertModal('File Too Large', `${file.name} is too large. Maximum size is 10MB.`, 'error');
                return false;
            }

            return true;
        });

        validFiles.forEach(file => {
            if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                selectedFiles.push(file);
            }
        });

        updatePreview();
        updateSubmitButton();
    }

    function updatePreview() {
        if (selectedFiles.length === 0) {
            filePreviewContainer.classList.add('d-none');
            return;
        }

        filePreviewContainer.classList.remove('d-none');
        fileCount.textContent = selectedFiles.length;
        filePreview.innerHTML = '';

        selectedFiles.forEach((file, index) => {
            const col = document.createElement('div');
            col.className = 'col-md-3 col-sm-4 col-6';

            const previewDiv = document.createElement('div');
            previewDiv.className = 'preview-image';

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.alt = file.name;

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '√ó';
            removeBtn.onclick = () => {
                selectedFiles.splice(index, 1);
                updatePreview();
                updateSubmitButton();
            };

            const nameDiv = document.createElement('div');
            nameDiv.className = 'small text-truncate mt-1';
            nameDiv.textContent = file.name;
            nameDiv.title = file.name;

            previewDiv.appendChild(img);
            previewDiv.appendChild(removeBtn);
            col.appendChild(previewDiv);
            col.appendChild(nameDiv);
            filePreview.appendChild(col);
        });
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = selectedFiles.length === 0;
    }

    document.getElementById('clear-files-btn').addEventListener('click', () => {
        selectedFiles = [];
        fileInput.value = '';
        updatePreview();
        updateSubmitButton();
    });

    document.getElementById('webtoon-upload-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        if (selectedFiles.length === 0) {
            window.showAlertModal('No Images', 'Please select at least one image to translate.', 'error');
            return;
        }

        const formData = new FormData();
        const ocrMethod = document.getElementById('ocr-method').value;
        const sourceLanguage = document.getElementById('source-language').value;

        selectedFiles.forEach(file => {
            formData.append('images', file);
        });
        formData.append('ocr_method', ocrMethod);
        formData.append('source_language', sourceLanguage);
        formData.append('overwrite_text', 'true');

        document.getElementById('submit-text').textContent = 'Uploading...';
        document.getElementById('submit-spinner').classList.remove('d-none');
        document.getElementById('submit-btn').disabled = true;

        try {

            const response = await window.fetchWithCSRF('/api/webtoon/translate', {
                method: 'POST',
                body: formData
            });

            const contentType = response.headers.get('content-type');
            let data;

            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else {

                const text = await response.text();
                console.error('Non-JSON response received:', text.substring(0, 500));

                try {
                    data = JSON.parse(text);
                } catch (e) {

                    throw new Error(`Server returned non-JSON response. Status: ${response.status}. Response: ${text.substring(0, 200)}`);
                }
            }

            if (response.ok) {
                currentJobId = data.job_id;
                document.getElementById('job-id-badge').textContent = `Job: ${data.job_id.substring(0, 8)}...`;
                showProgressSection();
                startPolling();
            } else {
                window.showAlertModal('Error', (data.error || 'Failed to create translation job'), 'error');
                resetForm();
            }
        } catch (error) {
            console.error('Upload error:', error);
            window.showAlertModal('Upload Error', 'Error uploading images: ' + error.message, 'error');
            resetForm();
        }
    });

    function showProgressSection() {
        document.getElementById('progress-section').classList.remove('d-none');
        document.getElementById('total-count').textContent = selectedFiles.length;
        document.getElementById('processed-count').textContent = '0';
    }

    function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(checkJobStatus, 2000);
    }

    async function checkJobStatus() {
        if (!currentJobId) return;

        try {
            const response = await fetch(`/api/webtoon/job/${currentJobId}`);
            const data = await response.json();

            const total = data.total_images || 1;
            let processed = 0;
            let failed = 0;

            if (data.images && Array.isArray(data.images)) {
                processed = data.images.filter(img => img.status === 'completed').length;
                failed = data.images.filter(img => img.status === 'failed').length;
            } else {

                processed = data.processed_images || 0;
                failed = data.failed_images || 0;
            }

            const total_processed = processed + failed;

            const progress = Math.min(100, total > 0 ? (total_processed / total * 100) : 0);

            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = Math.round(progress) + '%';

            document.getElementById('processed-count').textContent = total_processed;
            document.getElementById('total-count').textContent = total;
            document.getElementById('job-status').textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);

            const errorDiv = document.getElementById('error-messages');
            if (data.images && Array.isArray(data.images)) {
                const failedImages = data.images.filter(img => img.status === 'failed' && img.error_message);
                if (failedImages.length > 0) {
                    errorDiv.style.display = 'block';
                    errorDiv.innerHTML = '<strong>Errors:</strong><ul style="margin: 8px 0 0 0; padding-left: 20px;">' +
                        failedImages.map(img => `<li><strong>${img.filename}:</strong> ${img.error_message}</li>`).join('') +
                        '</ul>';
                } else {
                    errorDiv.style.display = 'none';
                }
            }

            if (data.status === 'completed' || data.status === 'completed_with_errors') {
                clearInterval(pollInterval);
                document.getElementById('progress-bar').classList.remove('progress-bar-animated');
                await displayResults(data);
            } else if (total_processed >= total && data.status !== 'completed' && data.status !== 'completed_with_errors') {

                console.log('All images processed but job status not updated yet, forcing completion...');

                setTimeout(async () => {
                    const response = await fetch(`/api/webtoon/job/${currentJobId}`);
                    const data = await response.json();
                    if (data.status === 'completed' || data.status === 'completed_with_errors') {
                        clearInterval(pollInterval);
                        document.getElementById('progress-bar').classList.remove('progress-bar-animated');
                        await displayResults(data);
                    }
                }, 2000);
            }
        } catch (error) {
            console.error('Error checking job status:', error);
        }
    }

    async function displayResults(jobData) {
        const resultsDiv = document.getElementById('image-results');
        resultsDiv.innerHTML = '<h5 class="mt-3">Translated Images:</h5><div class="row g-3" id="results-grid"></div>';

        const resultsGrid = document.getElementById('results-grid');

        if (jobData.images && Array.isArray(jobData.images)) {
            const completedImages = jobData.images.filter(img => img.status === 'completed' && img.translated_path);

            if (completedImages.length > 0) {
                completedImages.forEach(img => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-sm-6';

                    const imageUrl = `/images/${img.translated_path}`;

                    col.innerHTML = `
                    <div class="settings-card">
                        <h6 class="text-truncate" title="${img.original_filename}">${img.original_filename}</h6>
                        <img src="${imageUrl}" class="img-fluid mb-2" style="max-width: 100%; border-radius: 5px;" alt="Translated image" onerror="this.parentElement.innerHTML='<p class=\'text-danger\'>Image not found</p>'">
                        <a href="${imageUrl}" download="${img.original_filename}" class="btn btn-sm btn-primary w-100">Download</a>
                    </div>
                `;
                    resultsGrid.appendChild(col);
                });
                resetForm();
                return;
            }
        }

        try {
            const response = await fetch(`/api/webtoon/job/${currentJobId}/images`);
            const data = await response.json();

            if (data.images && data.images.length > 0) {
                data.images.forEach(img => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-sm-6';

                    col.innerHTML = `
                    <div class="settings-card">
                        <h6 class="text-truncate" title="${img.original_filename}">${img.original_filename}</h6>
                        <img src="${img.url}" class="img-fluid mb-2" style="max-width: 100%; border-radius: 5px;" alt="Translated image" onerror="this.parentElement.innerHTML='<p class=\'text-danger\'>Image not found: ${img.url}</p>'">
                        <a href="${img.url}" download="${img.original_filename}" class="btn btn-sm btn-primary w-100">Download</a>
                    </div>
                `;
                    resultsGrid.appendChild(col);
                });
            } else {

                if (jobData.images && jobData.images.length > 0) {
                    const failedImages = jobData.images.filter(img => img.status === 'failed');
                    if (failedImages.length > 0) {
                        resultsDiv.innerHTML = '<p class="text-danger">Translation failed. Check error messages below.</p>';
                        failedImages.forEach(img => {
                            resultsDiv.innerHTML += `<p class="text-danger"><strong>${img.filename}:</strong> ${img.error_message || 'Unknown error'}</p>`;
                        });
                    } else {
                        resultsDiv.innerHTML = '<p class="text-warning">No translated images available yet. Images may still be processing.</p>';
                    }
                } else {
                    resultsDiv.innerHTML = '<p class="text-warning">No translated images available yet.</p>';
                }
            }
        } catch (error) {
            resultsDiv.innerHTML = '<p class="text-danger">Error loading translated images: ' + error.message + '</p>';
        }

        resetForm();
    }

    function resetForm() {
        document.getElementById('submit-text').textContent = 'Start Translation';
        document.getElementById('submit-spinner').classList.add('d-none');
        document.getElementById('submit-btn').disabled = false;
        selectedFiles = [];
        fileInput.value = '';
        updatePreview();
    }
</script>
{% endblock %}