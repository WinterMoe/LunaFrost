{% extends "base.html" %}

{% block title %}
{% if chapter_index is not none %}
{{ chapter.get('translated_title', chapter.title) }} - Chapter Settings
{% else %}
{{ get_display_title(novel) }} - Novel Settings
{% endif %}
{% endblock %}

{% block content %}
<div class="container">
    <header>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            {% if chapter_index is not none %}
            <a href="/chapter/{{ novel_id }}/number/{{ chapter.get('chapter_number', chapter_index + 1) }}"
                class="btn btn-primary">‚Üê Back to Chapter</a>
            {% else %}
            <a href="/novel/{{ novel_id }}" class="btn btn-primary">‚Üê Back to Novel</a>
            {% endif %}
            {% if novel.get('novel_source_url') %}
            <a href="{{ novel.novel_source_url }}" target="_blank" class="btn btn-secondary">üîó View on Novelpia</a>
            {% endif %}
        </div>
        {% if chapter_index is not none %}
        <h1>{{ chapter.get('translated_title', chapter.title) }}</h1>
        <p class="subtitle">Chapter Settings</p>
        {% else %}
        <h1>{{ get_display_title(novel) }}</h1>
        <p class="subtitle">Novel Settings</p>
        {% endif %}
    </header>

    <style>
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapsible-header h2 {
            margin: 0;
        }

        .collapse-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            max-height: 2000px;
            opacity: 1;
            padding-top: 15px;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
    </style>

    <div id="alert-container"></div>

    {% if chapter_index is not none %}
    <div class="settings-card">
        <h2>üóëÔ∏è Chapter Management</h2>
        <p style="color: #718096; margin-bottom: 15px;">
            Delete Chapter {{ chapter.get('chapter_number', chapter_index + 1) }}:
            <strong>{{ chapter.get('translated_title', chapter.title) }}</strong>
            {% if chapter.get('translated_title') and chapter.get('translated_title') != chapter.title %}
            <br><em style="font-size: 0.9rem; color: #a0aec0;">ÏõêÏ†ú: {{ chapter.title }}</em>
            {% endif %}
        </p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/chapter/{{ novel_id }}/number/{{ chapter.get('chapter_number', chapter_index + 1) }}?edit=true"
                class="btn btn-warning" style="padding: 12px 24px;">
                ‚úèÔ∏è Edit Chapter Content
            </a>
            <a href="/chapter/{{ novel_id }}/number/{{ chapter.get('chapter_number', chapter_index + 1) }}?compare=true"
                class="btn btn-info" style="padding: 12px 24px;">
                ‚öñÔ∏è Compare Side-by-Side
            </a>
            <button id="delete-chapter-btn" class="btn btn-danger" style="padding: 12px 24px;"
                data-delete-type="chapter">
                üóëÔ∏è Delete This Chapter
            </button>
        </div>
    </div>
    {% endif %}

    {% if chapter_index is none %}
    {% if not novel.get('imported_from_share_token') %}
    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('novel-management-content', 'novel-management-icon')">
            <h2>üõ†Ô∏è Novel Management</h2>
            <span class="collapse-icon" id="novel-management-icon">‚ñº</span>
        </div>
        <div class="collapsible-content" id="novel-management-content">
            <p style="color: #718096; margin-bottom: 15px;">
                Manage your novel's metadata or merge it with another novel.
            </p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="edit-metadata-btn" class="btn btn-primary" style="padding: 12px 24px; flex: 1;">
                    ‚úèÔ∏è Edit Metadata
                </button>
                <button id="merge-novels-btn" class="btn btn-warning" style="padding: 12px 24px; flex: 1;">
                    üîÄ Merge Novels
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="settings-card">
        <h2>üìö Imported Shared Novel</h2>
        <p style="color: #718096; margin-bottom: 15px;">
            This novel was imported from a shared source. Novel management and sharing options are not available for
            imported novels.
        </p>
        <p style="color: #4a5568; margin-top: 15px;">
            Use the sync feature on the novel page to get updates from the original shared novel.
        </p>
    </div>
    {% endif %}

    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('export-content', 'export-icon')">
            <h2>üì• Export Novel</h2>
            <span class="collapse-icon collapsed" id="export-icon">‚ñº</span>
        </div>
        <div class="collapsible-content collapsed" id="export-content">
            <p style="color: #718096; margin-bottom: 15px;">
                Download the entire novel as PDF or EPUB.
            </p>
            <a href="/api/export/{{ novel_id }}/pdf" class="btn btn-export" download>üìÑ Download as PDF</a>
            <a href="/api/export/{{ novel_id }}/epub" class="btn btn-export" download>üìñ Download as EPUB</a>
        </div>
    </div>

    {% if not novel.get('imported_from_share_token') %}
    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('share-content', 'share-icon')">
            <h2>üîó Share Novel</h2>
            <span class="collapse-icon collapsed" id="share-icon">‚ñº</span>
        </div>
        <div class="collapsible-content collapsed" id="share-content">
            <p style="color: #718096; margin-bottom: 15px;">
                Create a public read-only link to share this novel with others.
            </p>

            <div id="share-container" style="display: {% if novel.is_shared %}block{% else %}none{% endif %};">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="share-link-input" class="form-control" readonly
                        value="{{ request.host_url }}shared/{{ novel.share_token }}" style="flex: 1; padding: 10px;">
                    <button id="copy-share-link-btn" class="btn btn-secondary">üìã Copy</button>
                </div>
                <button id="revoke-share-btn" class="btn btn-danger">üö´ Revoke Link</button>
            </div>

            <div id="no-share-container" style="display: {% if novel.is_shared %}none{% else %}block{% endif %};">
                <button id="generate-share-btn" class="btn btn-success">‚ú® Generate Share Link</button>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('glossary-content', 'glossary-icon')">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">üìù Character Glossary</h2>
            </div>
            <span class="collapse-icon" id="glossary-icon">‚ñº</span>
        </div>

        <div class="collapsible-content" id="glossary-content">
            {% if novel.get('imported_from_share_token') %}
            <div class="alert alert-info" style="margin-bottom: 20px;">
                üìö <strong>Read-only:</strong> This glossary was imported from the shared novel. Changes will sync
                automatically when you update from the original source.
            </div>
            {% else %}
            <div class="button-group">
                <button id="add-character-btn" class="btn btn-success">‚ûï Add Character Manually</button>
                <button id="save-settings-btn" class="btn btn-primary">üíæ Save Glossary</button>
                <button id="auto-detect-btn" class="btn btn-warning">Auto-Detect Characters</button>
            </div>

            <div class="alert alert-info">
                üí° <strong>Tip:</strong> Use Auto-Detect Characters to let the AI scan your chapters, translate names to
                English, and keep future novels consistent. Running it on a chapter that's already translated improves
                accuracy because the AI can compare both languages. Click any character to expand and edit details.
            </div>
            {% endif %}

            <div id="characters-container">
                {% if glossary %}
                {% for char_id, char_info in glossary.items() %}
                <div class="character-entry collapsed" data-char-id="{{ char_id }}">
                    <div class="character-header">
                        <div class="character-summary">
                            <span class="korean-name">{{ char_info.get('korean_name', '') }}</span>
                            <span class="arrow">‚Üí</span>
                            <span class="english-name">{{ char_info.get('english_name', '(Not set)') }}</span>
                            {% if char_info.get('gender') %}
                            <span class="gender-badge gender-{{ char_info.get('gender') }}">{{ char_info.get('gender')
                                }}</span>
                            {% else %}
                            <span class="gender-badge gender-auto">AI Auto-Select</span>
                            {% endif %}
                        </div>
                        <div class="character-actions">
                            {% if not novel.get('imported_from_share_token') %}
                            <button class="btn btn-danger btn-remove-char">‚úï</button>
                            {% endif %}
                            <span class="expand-icon">‚ñº</span>
                        </div>
                    </div>
                    <div class="character-details">
                        <div class="form-group">
                            <label>Korean Name (Original)</label>
                            <input type="text" class="char-korean" placeholder="e.g., ÍπÄÏ≤†Ïàò"
                                value="{{ char_info.get('korean_name', '')|e }}" {% if
                                novel.get('imported_from_share_token') %}readonly{% endif %}>
                        </div>

                        <div class="form-group">
                            <label>English Name (Translation)</label>
                            <input type="text" class="char-english" placeholder="e.g., John Kim"
                                value="{{ char_info.get('english_name', '')|e }}" {% if
                                novel.get('imported_from_share_token') %}readonly{% endif %}>
                        </div>

                        <div class="form-group">
                            <label>Gender</label>
                            <select class="char-gender" {% if novel.get('imported_from_share_token') %}disabled{% endif
                                %}>
                                <option value="auto" {% if not char_info.get('gender') or
                                    char_info.get('gender')=='auto' %}selected{% endif %}>AI Auto-Select
                                </option>
                                <option value="male" {% if char_info.get('gender')=='male' %}selected{% endif %}>Male
                                    (he/him)</option>
                                <option value="female" {% if char_info.get('gender')=='female' %}selected{% endif %}>
                                    Female
                                    (she/her)</option>
                                <option value="other" {% if char_info.get('gender')=='other' %}selected{% endif %}>Other
                                    (they/them)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Character Notes</label>
                            <textarea class="char-description"
                                placeholder="e.g., Main protagonist, skilled swordsman, age 25" {% if
                                novel.get('imported_from_share_token') %}readonly{% endif
                                %}>{{ char_info.get('description', '') }}</textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p id="empty-message" style="text-align: center; color: #718096; padding: 40px;">
                    {% if novel.get('imported_from_share_token') %}
                    No characters in the glossary.
                    {% else %}
                    No characters added yet. Click "Add Character Manually" or "Auto-Detect Characters" to get started.
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>

    </div>

    {% if show_delete_novel %}
    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('danger-zone-content', 'danger-zone-icon')">
            <h2>‚ö†Ô∏è Danger Zone</h2>
            <span class="collapse-icon collapsed" id="danger-zone-icon">‚ñº</span>
        </div>
        <div class="collapsible-content collapsed" id="danger-zone-content">
            <div class="alert alert-warning" style="margin-bottom: 15px; margin-top: 15px;">
                <strong>Warning:</strong> Deleting this novel will permanently remove all chapters, translations, and
                character glossary. This action cannot be undone.
            </div>
            <button id="delete-novel-btn" class="btn btn-danger" style="padding: 12px 24px;" data-delete-type="novel">
                üóëÔ∏è Delete Entire Novel
            </button>
        </div>
    </div>
    {% endif %}


    <div class="settings-card">
        <div class="collapsible-header" onclick="toggleCollapse('custom-prompt-content', 'custom-prompt-icon')">
            <h2>Custom Translation Prompt</h2>
            <span class="collapse-icon collapsed" id="custom-prompt-icon">‚ñº</span>
        </div>
        <div class="collapsible-content collapsed" id="custom-prompt-content">
            <p style="color: #718096; margin-bottom: 15px;">
                These instructions will be appended to the system prompt for every chapter in this novel.
                Useful for specifying character names, tone, or style.
            </p>
            <textarea id="novel-custom-prompt-suffix" class="form-control" rows="4"
                placeholder="e.g. Translate 'Hyung' as 'Brother'. Keep honorifics. Text style should be modern.">{{ novel.get('custom_prompt_suffix') or '' }}</textarea>

            <button id="save-prompt-btn" class="btn btn-primary" style="margin-top: 15px;">üíæ Save Custom
                Prompt</button>
        </div>
    </div>
</div>

<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <h2 style="color: #2d3748; margin-bottom: 10px;">Auto-Detecting Characters...</h2>
        <p style="color: #718096;">Analyzing chapters and translating names...</p>
        <div class="spinner"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<div id="novel-data-store" data-novel-id="{{ novel_id }}"
    data-chapter-index="{% if chapter_index is not none %}{{ chapter_index }}{% else %}null{% endif %}"
    data-chapter-number="{% if chapter %}{{ chapter.get('chapter_number', 'null') }}{% else %}null{% endif %}"
    data-chapter-id="{% if chapter %}{{ chapter.get('id', 'null') }}{% else %}null{% endif %}"
    data-glossary-length="{{ glossary | length if glossary else 0 }}"
    data-total-chapters="{{ novel.get('chapters', []) | length if novel else 0 }}" style="display:none;"></div>

<div id="edit-metadata-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div
        style="background: var(--bg-primary); width: 95%; max-width: 500px; max-height: 85vh; overflow-y: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div
            style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-light);">
            <h2 style="margin: 0; font-size: 1.2rem;">‚úèÔ∏è Edit Metadata</h2>
            <button id="close-metadata-modal"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
        </div>
        <div style="padding: 20px;">

            <div style="margin-bottom: 20px;">
                <label style="font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 8px;">Cover
                    Image</label>
                <div id="metadata-cover-preview" style="text-align: center; margin-bottom: 10px;">
                    {% if novel.get('cover_image') %}
                    <img src="/images/{{ novel.cover_image }}" alt="Current Cover" id="cover-preview-img"
                        style="max-width: 150px; height: auto; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    {% else %}
                    <div id="no-cover-placeholder"
                        style="width: 150px; height: 200px; background: var(--bg-secondary); border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        No Cover
                    </div>
                    {% endif %}
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="metadata-cover-input"
                        accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" style="flex: 1;">
                    <button id="metadata-upload-cover-btn" class="btn btn-secondary"
                        style="padding: 8px 16px;">Upload</button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 5px;">Title</label>
                <input type="text" id="metadata-title" class="form-control" placeholder="Novel Title"
                    value="{{ novel.get('translated_title', novel.get('title', '')) }}" style="padding: 10px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 5px;">Author</label>
                <input type="text" id="metadata-author" class="form-control" placeholder="Author Name"
                    value="{{ novel.get('translated_author', '') }}" style="padding: 10px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 5px;">Synopsis</label>
                <textarea id="metadata-synopsis" class="form-control" rows="4" placeholder="Synopsis..."
                    style="padding: 10px;">{{ novel.get('translated_synopsis', '') }}</textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 5px;">Tags
                    (comma-separated)</label>
                <input type="text" id="metadata-tags" class="form-control" placeholder="fantasy, action, romance"
                    value="{{ novel.get('translated_tags', [])|join(', ') }}" style="padding: 10px;">
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="cancel-metadata-btn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                <button id="save-metadata-btn" class="btn btn-success" style="flex: 2;">üíæ Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div id="merge-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div
        style="background: var(--bg-primary); width: 95%; max-width: 700px; max-height: 85vh; overflow-y: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div id="merge-modal-content">

        </div>
    </div>
</div>

<script>
    (function () {
        const dataStore = document.getElementById('novel-data-store');
        if (!dataStore) return;

        const novelId = dataStore.getAttribute('data-novel-id');
        const chapterIndexStr = dataStore.getAttribute('data-chapter-index');
        const chapterIndex = chapterIndexStr === 'null' ? null : parseInt(chapterIndexStr);
        const chapterNumberStr = dataStore.getAttribute('data-chapter-number');
        const chapterNumber = chapterNumberStr === 'null' ? null : chapterNumberStr;
        const chapterIdStr = dataStore.getAttribute('data-chapter-id');
        const chapterId = chapterIdStr === 'null' ? null : parseInt(chapterIdStr);

        window.novelSettingsData = {
            novelId: novelId,
            chapterIndex: chapterIndex,
            chapterNumber: chapterNumber,
            chapterId: chapterId,
            glossaryLength: parseInt(dataStore.getAttribute('data-glossary-length') || '0'),
            chapterText: "",
            totalChapters: parseInt(dataStore.getAttribute('data-total-chapters') || '0')
        };
    })();
</script>
<script src="{{ url_for('static', filename='js/csrf.js') }}"></script>
<script src="{{ url_for('static', filename='js/novel_settings.js') }}?v=1.1"></script>
<script src="{{ url_for('static', filename='js/novel_merge.js') }}?v=1.0"></script>

<script>
    (function () {
        let deleteInProgress = false;

        if (!window.novelSettingsData) {
            window.novelSettingsData = { novelId: '', chapterIndex: null, glossaryLength: 0, chapterText: '', totalChapters: 0 };
        }

        function handleDeleteClick(e) {

            if (!window.novelSettingsData || !window.novelSettingsData.novelId) {
                window.showAlertModal('Error', 'Novel ID not found. Please refresh the page and try again.', 'error');
                return;
            }
            e.preventDefault();
            e.stopPropagation();

            let deleteType = e.target.dataset.deleteType;

            if (deleteType === 'chapter' && window.novelSettingsData.totalChapters === 1) {
                window.showConfirmationModal(
                    'Delete Last Chapter?',
                    '‚ö†Ô∏è This is the last chapter in the novel.\n\nDeleting it will also delete the entire novel, including all translations and character glossary.\n\nAre you sure you want to proceed?',
                    () => {

                        performDelete('novel');
                    },
                    'danger'
                );
            } else {
                let title = 'Delete Chapter?';
                let message = 'Are you sure you want to delete this chapter? This action cannot be undone.';

                if (deleteType === 'novel') {
                    title = 'Delete Novel?';
                    message = 'Are you sure you want to delete this entire novel?\n\nThis will permanently remove all chapters, translations, and character glossary.\n\nThis action cannot be undone!';
                }

                window.showConfirmationModal(
                    title,
                    message,
                    () => {
                        performDelete(deleteType);
                    },
                    'danger'
                );
            }
        }

        async function performDelete(deleteType) {
            if (deleteInProgress) return;
            deleteInProgress = true;

            const loadingTitle = deleteType === 'chapter' ? 'Deleting Chapter...' : 'Deleting Novel...';

            try {
                let endpoint = '';
                let payload = {};

                if (deleteType === 'chapter') {
                    endpoint = '/api/delete-chapter';
                    payload = {
                        novel_id: window.novelSettingsData.novelId,
                        chapter_id: window.novelSettingsData.chapterId
                    };
                } else if (deleteType === 'novel') {
                    endpoint = '/api/delete-novel';
                    payload = {
                        novel_id: window.novelSettingsData.novelId
                    };
                }

                const response = await fetchWithCSRF(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    if (deleteType === 'chapter') {
                        window.showAlertModal('Success', '‚úì Chapter deleted successfully! Redirecting...', 'success');
                        setTimeout(function () {
                            window.location.href = '/novel/' + encodeURIComponent(window.novelSettingsData.novelId);
                        }, 1500);
                    } else {
                        window.showAlertModal('Success', '‚úì Novel deleted successfully! Redirecting...', 'success');
                        setTimeout(function () {
                            window.location.href = '/';
                        }, 1500);
                    }
                } else {
                    window.showAlertModal('Error', '‚ùå Error: ' + data.error, 'error');
                    deleteInProgress = false;
                }
            } catch (error) {
                window.showAlertModal('Error', '‚ùå An error occurred while deleting.', 'error');
                deleteInProgress = false;
            }
        }

        const deleteChapterBtn = document.getElementById('delete-chapter-btn');
        const deleteNovelBtn = document.getElementById('delete-novel-btn');

        if (deleteChapterBtn) {
            deleteChapterBtn.addEventListener('click', handleDeleteClick);
        }

        if (deleteNovelBtn) {
            deleteNovelBtn.addEventListener('click', handleDeleteClick);
        }

        window.toggleCollapse = function (contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            if (content && icon) {
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.classList.remove('collapsed');
                } else {
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                }
            }
        };
    })();

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alert-container');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
        alertDiv.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);
    }

    const editMetadataBtn = document.getElementById('edit-metadata-btn');
    const editMetadataModal = document.getElementById('edit-metadata-modal');
    const closeMetadataModal = document.getElementById('close-metadata-modal');
    const cancelMetadataBtn = document.getElementById('cancel-metadata-btn');
    const saveMetadataBtn = document.getElementById('save-metadata-btn');
    const metadataUploadCoverBtn = document.getElementById('metadata-upload-cover-btn');
    const metadataCoverInput = document.getElementById('metadata-cover-input');

    function openMetadataModal() {
        if (editMetadataModal) {
            editMetadataModal.style.display = 'flex';

            const usernameSuffixDisplay = document.getElementById('username-suffix-display');
            if (usernameSuffixDisplay && window.novelSettingsData && window.novelSettingsData.novelId) {

                const slugParts = window.novelSettingsData.novelId.split('_');
                if (slugParts.length >= 2) {
                    const username = slugParts[slugParts.length - 1];
                    usernameSuffixDisplay.textContent = '_' + username;
                }
            }
        }
    }

    function closeMetadataModalFn() {
        if (editMetadataModal) {
            editMetadataModal.style.display = 'none';
        }
    }

    if (editMetadataBtn) {
        editMetadataBtn.addEventListener('click', openMetadataModal);
    }

    if (closeMetadataModal) {
        closeMetadataModal.addEventListener('click', closeMetadataModalFn);
    }

    if (cancelMetadataBtn) {
        cancelMetadataBtn.addEventListener('click', closeMetadataModalFn);
    }

    if (editMetadataModal) {
        editMetadataModal.addEventListener('click', (e) => {
            if (e.target === editMetadataModal) {
                closeMetadataModalFn();
            }
        });
    }

    if (metadataUploadCoverBtn && metadataCoverInput) {
        metadataUploadCoverBtn.addEventListener('click', async () => {
            if (!metadataCoverInput.files || metadataCoverInput.files.length === 0) {
                window.showAlertModal('Error', 'Please select an image file first.', 'error');
                return;
            }

            const file = metadataCoverInput.files[0];
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                window.showAlertModal('Error', 'Invalid file type. Please select a PNG, JPG, GIF, or WebP image.', 'error');
                return;
            }

            metadataUploadCoverBtn.disabled = true;
            const originalText = metadataUploadCoverBtn.textContent;
            metadataUploadCoverBtn.textContent = 'Uploading...';

            try {
                const formData = new FormData();
                formData.append('cover_image', file);

                const response = await window.fetchWithCSRF(`/api/novel/${encodeURIComponent(window.novelSettingsData.novelId)}/cover`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {

                    const previewContainer = document.getElementById('metadata-cover-preview');
                    const placeholder = document.getElementById('no-cover-placeholder');
                    let previewImg = document.getElementById('cover-preview-img');

                    if (placeholder) {
                        placeholder.remove();
                    }

                    if (!previewImg) {
                        previewImg = document.createElement('img');
                        previewImg.id = 'cover-preview-img';
                        previewImg.alt = 'Current Cover';
                        previewImg.style.cssText = 'max-width: 150px; height: auto; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                        previewContainer.appendChild(previewImg);
                    }

                    previewImg.src = `/images/${data.cover_url}?t=${Date.now()}`;
                    window.showAlertModal('Success', 'Cover image uploaded!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to upload cover image');
                }
            } catch (error) {
                console.error('Error uploading cover:', error);
                window.showAlertModal('Error', error.message, 'error');
            } finally {
                metadataUploadCoverBtn.disabled = false;
                metadataUploadCoverBtn.textContent = originalText;
                metadataCoverInput.value = '';
            }
        });
    }

    if (saveMetadataBtn) {
        saveMetadataBtn.addEventListener('click', async () => {
            const title = document.getElementById('metadata-title').value.trim();
            const author = document.getElementById('metadata-author').value.trim();
            const synopsis = document.getElementById('metadata-synopsis').value.trim();
            const tagsStr = document.getElementById('metadata-tags').value.trim();
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

            if (title && title.includes('_')) {
                window.showAlertModal('Error', 'Title cannot contain underscores (_). Please use a different character.', 'error');
                return;
            }

            saveMetadataBtn.disabled = true;
            const originalText = saveMetadataBtn.textContent;
            saveMetadataBtn.textContent = 'Saving...';

            try {
                const response = await window.fetchWithCSRF(`/api/novel/${encodeURIComponent(window.novelSettingsData.novelId)}/metadata`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        author: author,
                        synopsis: synopsis,
                        tags: tags
                    })
                });

                const data = await response.json();

                if (data.success) {
                    window.showAlertModal('Success', 'Metadata saved successfully!', 'success');
                    setTimeout(() => {

                        if (data.new_slug && data.new_slug !== window.novelSettingsData.novelId) {
                            window.location.href = `/novel/${encodeURIComponent(data.new_slug)}/settings`;
                        } else {
                            window.location.reload();
                        }
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Failed to save metadata');
                }
            } catch (error) {
                console.error('Error saving metadata:', error);
                window.showAlertModal('Error', error.message, 'error');
                saveMetadataBtn.disabled = false;
                saveMetadataBtn.textContent = originalText;
            }
        });
    }

    const savePromptBtn = document.getElementById('save-prompt-btn');
    if (savePromptBtn) {
        savePromptBtn.addEventListener('click', async () => {
            const customPrompt = document.getElementById('novel-custom-prompt-suffix').value.trim();

            savePromptBtn.disabled = true;
            const originalText = savePromptBtn.textContent;
            savePromptBtn.textContent = 'Saving...';

            try {

                const title = document.getElementById('metadata-title').value.trim();
                const author = document.getElementById('metadata-author').value.trim();
                const synopsis = document.getElementById('metadata-synopsis').value.trim();
                const tagsStr = document.getElementById('metadata-tags').value.trim();
                const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

                const response = await fetch(`/api/novel/${encodeURIComponent(window.novelSettingsData.novelId)}/metadata`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        author: author,
                        synopsis: synopsis,
                        tags: tags,
                        custom_prompt_suffix: customPrompt
                    })
                });

                const data = await response.json();
                if (data.success) {
                    window.showAlertModal('Success', 'Custom prompt saved!', 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error saving prompt:', error);
                window.showAlertModal('Error', error.message, 'error');
            } finally {
                savePromptBtn.disabled = false;
                savePromptBtn.textContent = originalText;
            }
        });
    }
</script>
{% endblock %}