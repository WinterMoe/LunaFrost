<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}LunaFrost Translator{% endblock %}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}?v=2">

    <style>
        html {
            visibility: hidden;
            opacity: 0;
        }
    </style>

    <script>
        (function () {
            var mode = 'light';
            try {
                var prefs = localStorage.getItem('lf_reading_prefs');
                if (prefs) {
                    var data = JSON.parse(prefs);
                    mode = data.colorMode || data.color_mode || 'light';
                } else {
                    var darkMode = localStorage.getItem('lf_dark_mode');
                    if (darkMode === 'true') mode = 'dark';
                }
            } catch (e) { }

            var html = document.documentElement;
            html.className = '';

            if (mode === 'dark') {
                html.className = 'dark-mode';
            } else if (mode === 'sepia') {
                html.className = 'sepia-mode';
            } else if (mode === 'high-contrast') {
                html.className = 'high-contrast-mode';
            }
        })();
    </script>

    <style>
        html {
            background-color: #FAFAFA;
            color: #2D2D2D;
        }

        body {
            background-color: #FAFAFA;
            color: #2D2D2D;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .container {
            background-color: #FAFAFA !important;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        .container,
        .content-area,
        .chapter-list,
        .novel-card,
        .settings-card,
        header,
        .auth-card,
        .breakdown-card,
        .stat-card,
        .help-section,
        .empty-state,
        .chapter-item,
        .character-entry,
        .toggle-item,
        section,
        main,
        article {
            background-color: #FFFFFF;
            color: #2D2D2D;
        }

        input,
        select,
        textarea,
        button {
            background-color: #FFFFFF;
            color: #2D2D2D;
            border-color: #E8E8E6;
        }

        .dropdown-overlay {
            background-color: transparent !important;
        }

        html.dark-mode {
            background-color: #1A1A1A;
            color: #E8E6E3;
        }

        html.dark-mode body {
            background-color: #1A1A1A;
            color: #E8E6E3;
        }

        html.dark-mode .container {
            background-color: #1A1A1A !important;
        }

        html.dark-mode .container,
        html.dark-mode .content-area,
        html.dark-mode .chapter-list,
        html.dark-mode .novel-card,
        html.dark-mode .settings-card,
        html.dark-mode header,
        html.dark-mode .auth-card,
        html.dark-mode .breakdown-card,
        html.dark-mode .stat-card,
        html.dark-mode .help-section,
        html.dark-mode .empty-state,
        html.dark-mode .chapter-item,
        html.dark-mode .character-entry,
        html.dark-mode .toggle-item,
        html.dark-mode section,
        html.dark-mode main,
        html.dark-mode article {
            background-color: #242424;
            color: #E8E6E3;
        }

        html.dark-mode input,
        html.dark-mode select,
        html.dark-mode textarea,
        html.dark-mode button {
            background-color: #242424;
            color: #E8E6E3;
            border-color: #383836;
        }

        html.sepia-mode {
            background-color: #F4ECD8;
            color: #3D3020;
        }

        html.sepia-mode body {
            background-color: #F4ECD8;
            color: #3D3020;
        }

        html.sepia-mode .container {
            background-color: #F4ECD8 !important;
        }

        html.sepia-mode .container,
        html.sepia-mode .content-area,
        html.sepia-mode .chapter-list,
        html.sepia-mode .novel-card,
        html.sepia-mode .settings-card,
        html.sepia-mode header,
        html.sepia-mode .auth-card,
        html.sepia-mode .breakdown-card,
        html.sepia-mode .stat-card,
        html.sepia-mode .help-section,
        html.sepia-mode .empty-state,
        html.sepia-mode .chapter-item,
        html.sepia-mode .character-entry,
        html.sepia-mode .toggle-item,
        html.sepia-mode section,
        html.sepia-mode main,
        html.sepia-mode article {
            background-color: #F9F5E8;
            color: #3D3020;
        }

        html.sepia-mode input,
        html.sepia-mode select,
        html.sepia-mode textarea,
        html.sepia-mode button {
            background-color: #F9F5E8;
            color: #3D3020;
            border-color: #DDD3BE;
        }

        html.high-contrast-mode {
            background-color: #000000;
            color: #FFFFFF;
        }

        html.high-contrast-mode body {
            background-color: #000000;
            color: #FFFFFF;
        }

        html.high-contrast-mode .container {
            background-color: #000000 !important;
        }

        html.high-contrast-mode .container,
        html.high-contrast-mode .content-area,
        html.high-contrast-mode .chapter-list,
        html.high-contrast-mode .novel-card,
        html.high-contrast-mode .settings-card,
        html.high-contrast-mode header,
        html.high-contrast-mode .auth-card,
        html.high-contrast-mode .breakdown-card,
        html.high-contrast-mode .stat-card,
        html.high-contrast-mode .help-section,
        html.high-contrast-mode .empty-state,
        html.high-contrast-mode .chapter-item,
        html.high-contrast-mode .character-entry,
        html.high-contrast-mode .toggle-item,
        html.high-contrast-mode section,
        html.high-contrast-mode main,
        html.high-contrast-mode article {
            background-color: #000000;
            color: #FFFFFF;
        }

        html.high-contrast-mode input,
        html.high-contrast-mode select,
        html.high-contrast-mode textarea,
        html.high-contrast-mode button {
            background-color: #000000;
            color: #FFFFFF;
            border-color: #FFFF00;
        }

        :root {
            --bg-primary: #FAFAFA;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F5F5F4;
            --bg-hover: #F0F0EF;
            --accent-primary: #a99bea;
            --accent-primary-hover: #9485db;
            --accent-light: #F0EDF9;
            --accent-muted: #c4baef;
            --text-primary: #2D2D2D;
            --text-secondary: #6B6B6B;
            --text-muted: #9A9A9A;
            --text-inverse: #FFFFFF;
            --border-light: #E8E8E6;
            --border-medium: #D4D4D2;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        html.dark-mode {
            --bg-primary: #1A1A1A;
            --bg-secondary: #242424;
            --bg-tertiary: #2E2E2E;
            --bg-hover: #383838;
            --accent-primary: #b8acf0;
            --accent-primary-hover: #c9bff5;
            --accent-light: #2D2A3A;
            --accent-muted: #a99bea;
            --text-primary: #E8E6E3;
            --text-secondary: #A8A6A3;
            --text-muted: #787876;
            --text-inverse: #1A1A1A;
            --border-light: #383836;
            --border-medium: #484846;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        html.sepia-mode {
            --bg-primary: #F4ECD8;
            --bg-secondary: #F9F5E8;
            --bg-tertiary: #EFE5D0;
            --bg-hover: #E8DDC8;
            --accent-primary: #8B7355;
            --accent-primary-hover: #7A6449;
            --accent-light: #E8DDCC;
            --accent-muted: #A08872;
            --text-primary: #3D3020;
            --text-secondary: #5D4F3A;
            --text-muted: #8B7D68;
            --text-inverse: #F9F5E8;
            --border-light: #DDD3BE;
            --border-medium: #C9BFAA;
            --shadow-sm: 0 1px 2px rgba(61, 48, 32, 0.08);
            --shadow-md: 0 2px 8px rgba(61, 48, 32, 0.12);
            --shadow-lg: 0 4px 16px rgba(61, 48, 32, 0.16);
        }

        html.high-contrast-mode {
            --bg-primary: #000000;
            --bg-secondary: #000000;
            --bg-tertiary: #1A1A1A;
            --bg-hover: #2A2A2A;
            --accent-primary: #FFFF00;
            --accent-primary-hover: #FFFF33;
            --accent-light: #333300;
            --accent-muted: #CCCC00;
            --text-primary: #FFFFFF;
            --text-secondary: #FFFF00;
            --text-muted: #CCCCCC;
            --text-inverse: #000000;
            --border-light: #FFFF00;
            --border-medium: #FFFF00;
            --shadow-sm: 0 2px 4px rgba(255, 255, 0, 0.3);
            --shadow-md: 0 4px 8px rgba(255, 255, 0, 0.4);
            --shadow-lg: 0 8px 16px rgba(255, 255, 0, 0.5);
        }
    </style>

    <script>

        document.documentElement.style.visibility = 'visible';
        document.documentElement.style.opacity = '1';
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Literata:opsz,wght@7..72,400;7..72,500&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500&family=Noto+Sans+KR:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/opendyslexic.css') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=3">
    {% block extra_css %}{% endblock %}
</head>

<body>

    <div class="dropdown-overlay" id="dropdown-overlay"></div>

    <div id="user-menu">

        <div id="color-mode-switcher" class="color-mode-switcher">
            <span class="current-mode-emoji">‚òÄÔ∏è</span>
            <div class="mode-dropdown">
                <button class="mode-option" data-mode="light">‚òÄÔ∏è Light</button>
                <button class="mode-option" data-mode="dark">üåô Dark</button>
                <button class="mode-option" data-mode="sepia">üìú Sepia</button>
                <button class="mode-option" data-mode="high-contrast">üîÜ High Contrast</button>
            </div>
        </div>

        <div id="user-info">
            <span id="current-username"></span>
            <div class="avatar-circle" id="avatar-circle"></div>
            <div class="profile-dropdown" id="profile-dropdown">
                <a href="/settings" class="profile-link">
                    <span>‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
                <a href="/token-usage" class="profile-link">
                    <span>üìä</span>
                    <span>Token Usage</span>
                </a>
                <a href="/auth/profile" class="profile-link">
                    <span>üë§</span>
                    <span>Profile</span>
                </a>
                <a href="/auth/logout" class="logout-link">
                    <span>üö™</span>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </div>

    {% block content %}{% endblock %}

    <script>

        const userMenu = document.getElementById('user-menu');
        const userInfo = document.getElementById('user-info');
        const profileDropdown = document.getElementById('profile-dropdown');
        const dropdownOverlay = document.getElementById('dropdown-overlay');

        userInfo.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('open');
            dropdownOverlay.classList.toggle('active');
        });

        profileDropdown.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                profileDropdown.classList.remove('open');
                dropdownOverlay.classList.remove('active');
            });
        });

        dropdownOverlay.addEventListener('click', () => {
            profileDropdown.classList.remove('open');
            dropdownOverlay.classList.remove('active');
        });

        profileDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                profileDropdown.classList.remove('open');
                dropdownOverlay.classList.remove('active');
            }
        });

        fetch('/api/check-auth')
            .then(response => response.json())
            .then(data => {
                if (data.authenticated) {
                    const username = data.username;
                    const initials = username.substring(0, 2).toUpperCase();
                    document.getElementById('current-username').textContent = username;
                    document.getElementById('avatar-circle').textContent = initials;

                    if (data.is_admin === true || data.is_admin === 'true' || data.is_admin === 1) {
                        const profileDropdown = document.getElementById('profile-dropdown');
                        if (profileDropdown) {
                            const existingAdminLink = profileDropdown.querySelector('a[href="/admin"]');
                            if (!existingAdminLink) {
                                const adminLink = document.createElement('a');
                                adminLink.href = '/admin';
                                adminLink.className = 'profile-link';
                                adminLink.innerHTML = `
                                    <span>üëë</span>
                                    <span>Admin Portal</span>
                                `;
                                profileDropdown.insertBefore(adminLink, profileDropdown.firstChild);
                            }
                        }
                    }

                    userMenu.style.display = 'flex';

                    try {
                        const cached = localStorage.getItem('lf_model_pricing_ts');
                        const now = Date.now();
                        if (!cached || (now - parseInt(cached, 10)) > 12 * 60 * 60 * 1000) {
                            fetch('/api/pricing')
                                .then(r => r.json())
                                .then(data => {
                                    if (data && data.success) {
                                        try { localStorage.setItem('lf_model_pricing', JSON.stringify(data.pricing || {})); } catch (e) { }
                                        try { localStorage.setItem('lf_model_pricing_ts', String(Date.now())); } catch (e) { }
                                    }
                                })
                                .catch(e => { });
                        }
                    } catch (e) { }
                } else {
                    userMenu.style.display = 'none';
                }
            })
            .catch(err => {
                console.error('Failed to load user info:', err);
                userMenu.style.display = 'none';
            });
    </script>

    <div id="global-modal" class="modal-overlay"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:2000;">
        <div class="modal-content"
            style="background:var(--bg-secondary); width:90%; max-width:400px; border-radius:12px; padding:24px; border: 1px solid var(--border-light); box-shadow: var(--shadow-lg);">
            <div style="text-align:center; margin-bottom:20px;">
                <div id="global-modal-icon" style="font-size:3rem; margin-bottom:16px;">‚ö†Ô∏è</div>
                <h3 id="global-modal-title" style="margin:0 0 8px 0; color:var(--text-primary); font-size:1.25rem;">
                    Confirmation</h3>
                <p id="global-modal-message" style="margin:0; color:var(--text-secondary); line-height:1.5;">Are you
                    sure?</p>
            </div>
            <div style="display:flex; gap:12px; justify-content:center;">
                <button id="global-modal-cancel" class="btn btn-secondary" style="flex:1;">Cancel</button>
                <button id="global-modal-confirm" class="btn btn-primary" style="flex:1;">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        window.globalModal = {
            overlay: document.getElementById('global-modal'),
            title: document.getElementById('global-modal-title'),
            message: document.getElementById('global-modal-message'),
            icon: document.getElementById('global-modal-icon'),
            confirmBtn: document.getElementById('global-modal-confirm'),
            cancelBtn: document.getElementById('global-modal-cancel'),
            onConfirm: null
        };

        function closeGlobalModal() {
            window.globalModal.overlay.style.display = 'none';
            window.globalModal.onConfirm = null;
        }

        window.globalModal.cancelBtn.addEventListener('click', closeGlobalModal);
        window.globalModal.overlay.addEventListener('click', (e) => {
            if (e.target === window.globalModal.overlay) closeGlobalModal();
        });

        window.globalModal.confirmBtn.addEventListener('click', () => {
            if (window.globalModal.onConfirm) window.globalModal.onConfirm();
            closeGlobalModal();
        });

        window.showConfirmationModal = function (title, message, onConfirm, type = 'warning') {
            window.globalModal.title.textContent = title;
            window.globalModal.message.textContent = message;
            window.globalModal.onConfirm = onConfirm;
            window.globalModal.confirmBtn.className = 'btn btn-primary';
            window.globalModal.confirmBtn.textContent = 'Confirm';
            window.globalModal.cancelBtn.style.display = 'block';

            if (type === 'danger') {
                window.globalModal.icon.textContent = 'üóëÔ∏è';
                window.globalModal.confirmBtn.className = 'btn btn-danger';
                window.globalModal.confirmBtn.textContent = 'Delete';
            } else if (type === 'info') {
                window.globalModal.icon.textContent = '‚ÑπÔ∏è';
            } else {
                window.globalModal.icon.textContent = '‚ö†Ô∏è';
            }
            window.globalModal.overlay.style.display = 'flex';
        };

        window.showAlertModal = function (title, message, type = 'info') {
            window.globalModal.title.textContent = title;
            window.globalModal.message.textContent = message;
            window.globalModal.onConfirm = null;
            window.globalModal.cancelBtn.style.display = 'none';
            window.globalModal.confirmBtn.textContent = 'OK';
            window.globalModal.confirmBtn.className = 'btn btn-primary';

            if (type === 'success') {
                window.globalModal.icon.textContent = '‚úÖ';
            } else if (type === 'error') {
                window.globalModal.icon.textContent = '‚ùå';
                window.globalModal.confirmBtn.className = 'btn btn-danger';
            } else {
                window.globalModal.icon.textContent = '‚ÑπÔ∏è';
            }
            window.globalModal.overlay.style.display = 'flex';
        };
    </script>

    {% block extra_js %}{% endblock %}

    <script src="{{ url_for('static', filename='js/csrf.js') }}"></script>
    <script src="{{ url_for('static', filename='js/reading-preferences.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const switcher = document.getElementById('color-mode-switcher');
            if (!switcher) return;

            const emojiSpan = switcher.querySelector('.current-mode-emoji');
            const modeEmojis = {
                'light': '‚òÄÔ∏è',
                'dark': 'üåô',
                'sepia': 'üìú',
                'high-contrast': 'üîÜ'
            };

            const initSwitcher = setInterval(() => {
                if (window.ReadingPreferences && window.ReadingPreferences.current) {
                    clearInterval(initSwitcher);
                    updateSwitcherUI();

                    const originalApply = window.ReadingPreferences.apply;
                    window.ReadingPreferences.apply = function (prefs) {
                        originalApply.call(window.ReadingPreferences, prefs);
                        updateSwitcherUI();
                    };
                }
            }, 100);

            function updateSwitcherUI() {
                const currentMode = window.ReadingPreferences.current.colorMode;
                if (emojiSpan) emojiSpan.textContent = modeEmojis[currentMode] || '‚òÄÔ∏è';

                switcher.querySelectorAll('.mode-option').forEach(btn => {
                    if (btn.dataset.mode === currentMode) {
                        btn.style.backgroundColor = 'var(--bg-hover)';
                        btn.style.color = 'var(--accent-primary)';
                    } else {
                        btn.style.backgroundColor = '';
                        btn.style.color = '';
                    }
                });
            }

            switcher.addEventListener('click', (e) => {
                e.stopPropagation();
                switcher.classList.toggle('open');
            });

            document.addEventListener('click', () => {
                switcher.classList.remove('open');
            });

            switcher.querySelectorAll('.mode-option').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const newMode = btn.dataset.mode;
                    await window.ReadingPreferences.save({ colorMode: newMode });
                    window.ReadingPreferences.apply(window.ReadingPreferences.current);
                    switcher.classList.remove('open');
                });
            });
        });
    </script>
    <footer
        style="text-align: center; padding: var(--space-xl) var(--space-lg); margin-top: var(--space-2xl); border-top: 1px solid var(--border-light); color: var(--text-muted); font-size: 0.9rem;">
        <div style="margin-bottom: var(--space-sm);">
            <a href="/about"
                style="color: var(--accent-primary); text-decoration: none; margin: 0 var(--space-md);">About</a>
            <span style="color: var(--border-medium);">|</span>
            <a href="/contact"
                style="color: var(--accent-primary); text-decoration: none; margin: 0 var(--space-md);">Contact</a>
        </div>
        <div style="margin-top: var(--space-sm); font-size: 0.85rem;">
            ¬© 2025 LunaFrost Translator. All rights reserved.
        </div>
    </footer>
</body>

</html>